data_dir = "/var/lib/vector"

[sources.docker_logs]
type = "docker_logs"
docker_host = "unix:///var/run/docker.sock"
exclude_containers = ["clubhouse-vector"]

[transforms.third_party_docker]
type = "filter"
inputs = ["docker_logs"]
condition = '.container_name == "clubhouse-redis" || .container_name == "clubhouse-prometheus" || .container_name == "clubhouse-alertmanager" || .container_name == "clubhouse-tempo" || .container_name == "clubhouse-loki" || .container_name == "clubhouse-grafana" || .container_name == "clubhouse-caddy"'

[transforms.normalize_docker]
type = "remap"
inputs = ["third_party_docker"]
source = '''
service = .container_name
ts = .timestamp
parsed = parse_json(.message) ?? null
if is_object(parsed) {
  . = parsed
}
if service == "clubhouse-redis" && !is_object(parsed) {
  redis_match = parse_regex(.message, r'^(?P<pid>\d+):(?P<role>[A-Z]) (?P<date>\d{2} \w{3} \d{4}) (?P<time>\d{2}:\d{2}:\d{2}\.\d{3}) (?P<level>[#*.-]) (?P<msg>.*)$') ?? null
  if is_object(redis_match) {
    .redis_pid = redis_match.pid
    .redis_role = redis_match.role
    .redis_level = redis_match.level
    .message = redis_match.msg
  }
}
.timestamp = ts
.service = service
.container = service
.source = "docker"
'''

[sources.postgres_json]
type = "file"
include = ["/var/lib/postgresql/log/*.json"]
read_from = "end"

[transforms.normalize_postgres]
type = "remap"
inputs = ["postgres_json"]
source = '''
parsed = parse_json(.message)
if is_object(parsed) {
  . = parsed
}
.service = "postgres"
.container = "clubhouse-postgres"
.source = "postgres-jsonlog"
'''

[sinks.loki]
type = "loki"
inputs = ["normalize_docker", "normalize_postgres"]
endpoint = "http://loki:3100"
labels = { service = "{{ service }}", source = "{{ source }}" }
encoding.codec = "json"
