services:
  postgres-test:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: clubhouse_test
      POSTGRES_PASSWORD: clubhouse_test
      POSTGRES_DB: clubhouse_test
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clubhouse_test"]
      interval: 2s
      timeout: 5s
      retries: 10

  # Test Redis (optional, tests use miniredis by default)
  redis-test:
    image: redis:7-alpine
    container_name: clubhouse-redis-test
    command: redis-server --requirepass clubhouse_test
    ports:
      - "6380:6379"
    tmpfs:
      - /data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "clubhouse_test", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10

  backend-test:
    build:
      context: .
      dockerfile: Dockerfile.backend-test
    working_dir: /workdir
    volumes:
      - ../:/workdir
    environment:
      CLUBHOUSE_TEST_DATABASE_URL: "postgres://clubhouse_test:clubhouse_test@postgres-test:5432/clubhouse_test?sslmode=disable"
      PGHOST: postgres-test
    depends_on:
      postgres-test:
        condition: service_healthy
